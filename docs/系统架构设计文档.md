## 系统架构设计文档：气定神闲仪 (Zen-Motion Meter) 基于 ESP32-C3 SuperMini 的实现

### 1. 项目概述

**项目名称**：气定神闲仪 (Zen-Motion Meter)

**平台**：PlatformIO

**硬件平台**：ESP32-C3 SuperMini

**开发环境**：PlatformIO（基于 Visual Studio Code）

**目标功能**：

1. 稳定性评分
2. 时长记录
3. “破定”提醒
4. 计时器功能
5. 可以按天进行锻炼时长统计和历史数据查看（至少7日内）

------

### 2. 系统架构

本系统主要由以下几个模块组成：

- **硬件模块**：
  - **ESP32-C3 SuperMini**：作为核心处理单元，负责数据采集、处理、无线通信等。
  - **MPU6050（陀螺仪）**：用于实时检测练习者的身体稳定性。
  - **OLED显示屏**：显示稳定性评分、时长、累计时长等信息。
  - **蜂鸣器**：提供反馈声音。
  - **锂电池**：为系统提供电力。
- **软件模块**：
  - **ESP32-C3固件**：负责数据采集、处理、显示、蜂鸣器控制等。
  - **UI设计**：OLED屏幕显示界面布局，提供用户交互和信息反馈。
  - **系统管理**：电池管理、休眠模式等。

------

### 3. 软件设计

#### 3.1 系统架构图

```plaintext
-----------------------------------------------------------
|                          ESP32-C3 SuperMini              |
|  +---------------------------------------------------+  |
|  |  MPU6050 (传感器)                                  |  |
|  |  OLED 屏幕 显示                                     |  |
|  |  蜂鸣器                                             |  |
|  |  锂电池管理                                        |  |
|  |  蓝牙/ Wi-Fi 通信（BLE/Wi-Fi）                     |  |
|  |  电池管理                                          |  |
|  +---------------------------------------------------+  |
-----------------------------------------------------------
```

#### 3.2 功能模块

1. **稳定性评分模块**（基于 MPU6050）：
   - **算法**：通过MPU6050的加速度计和陀螺仪数据来监测用户的身体晃动幅度。根据X、Y、Z轴的加速度和角度变化来判断姿势的稳定性。
   - **思路**：当用户站桩或马步时，设备会连续采集传感器数据。根据晃动幅度的变化计算稳定性评分，分数越高代表姿势越稳。
   - **程序实现**：使用 `Wire` 库与 MPU6050 进行通信，获取加速度数据。
   - **稳定性计算**：通过计算加速度的变化率来判断稳定性。例如，取加速度数据的标准差，若标准差较小，则认为用户保持稳定。
2. **时长记录模块**：
   - **算法**：记录每次练习的开始和结束时间，计算练习时长并进行显示。
   - **思路**：使用ESP32的 `millis()` 函数来获取系统时间戳，记录练习开始时间，再计算经过的时间来得出练习时长。
   - **程序实现**：设置一个计时器，通过 `millis()` 函数记录开始时间和结束时间。
3. **破定提醒模块**：
   - **算法**：设定一个阈值，如果MPU6050采集到的晃动超过设定的阈值（表示身体不稳定），蜂鸣器会发出“嘀”声。
   - **思路**：如果稳定性评分低于阈值，则触发蜂鸣器。
   - **程序实现**：根据稳定性评分判断是否触发蜂鸣器。
4. **计时器功能模块**：
   - **算法**：用户可以设置练习时长，时间到达后设备发出提醒。
   - **思路**：通过设置倒计时，检查当前时间是否超过预设的时长。
   - **程序实现**：使用 `millis()` 计时并与用户设置的时长进行对比。

------

### 4. UI设计与布局

#### 4.1 OLED屏幕显示设计

本项目使用0.96寸的OLED显示屏（SSD1306驱动）。以下是UI的具体布局设计：

- **屏幕分为两个主要部分：**
  - **顶部区域（稳定性评分）：** 显示当前的稳定性评分（0-100分），实时反馈用户的稳定性。
  - **下半部分（练习时长/提示）：**
    - 显示当前练习时长，格式为“XX:XX”，以及累计时长。
    - 提示信息，例如“破定提醒”或“计时结束”等。

**UI布局：**

```
-------------------------------
|        稳定性评分: 85         |
|                               |
|        练习时长: 05:20        |
|                               |
|        累计时长: 1h 30m       |
|                               |
|        ----破定提醒----      |
|                               |
-------------------------------
```

- **稳定性评分区域**：
  - 显示当前的稳定性评分，动态更新。
  - 当评分较低时，可以显示红色提示：“保持稳定！”
- **练习时长和累计时长区域**：
  - 显示实时的练习时长。
  - 显示累计的练习时长，可以根据用户需求调整显示格式。
- **破定提醒**：
  - 当设备检测到不稳定的姿势时，显示提示信息“破定提醒”，并通过蜂鸣器发出声音提醒。

#### 4.2 显示更新逻辑

- **稳定性评分**：每次采集新的传感器数据时，更新屏幕上的稳定性评分。
- **练习时长**：每次开始或停止练习时，更新显示的练习时长。
- **破定提醒**：如果稳定性评分低于某个阈值，立即更新屏幕，显示“破定提醒”。

------

### 5. 程序设计与实现

#### 5.1 主程序框架

```cpp
#include <Wire.h>
#include <MPU6050.h>
#include <OLEDDisplay.h>
#include <BLEDevice.h>
#include <WiFi.h>

// 初始化硬件
MPU6050 mpu;
OLEDDisplay display;
BLEServer *pServer;
WiFiClient wifiClient;

// 全局变量
unsigned long startMillis;
unsigned long currentMillis;
int stabilityScore = 100;  // 初始稳定性评分

void setup() {
  // 初始化硬件
  Wire.begin();
  mpu.initialize();
  display.init();
  
  // 蓝牙或Wi-Fi初始化
  BLEDevice::init("Zen-Motion Meter");
  
  // 启动计时器
  startMillis = millis();
}

void loop() {
  // 读取传感器数据并计算稳定性评分
  getStabilityScore();
  
  // 更新屏幕显示
  updateDisplay();
  
  // 检查是否触发破定提醒
  checkForBreak();

  // 检查无线数据同步
  syncData();
}

void getStabilityScore() {
  // 从MPU6050读取数据并计算稳定性
  // 具体的稳定性计算逻辑
  stabilityScore = calculateStability();
}

void updateDisplay() {
  display.clear();
  display.setCursor(0, 0);
  display.print("稳定性评分: ");
  display.print(stabilityScore);
  
  display.setCursor(0, 16);
  display.print("练习时长: ");
  display.print((millis() - startMillis) / 1000);
  
  display.display();
}

void checkForBreak() {
  if (stabilityScore < 50) {
    display.setCursor(0, 32);
    display.print("破定提醒");
    // 发出蜂鸣器提示
  }
}

void syncData() {
  // 如果开启了Wi-Fi或BLE，进行数据同步
}
```

------

### 6. 使用的主要库

1. **MPU6050库**：用于与MPU6050传感器进行通信并读取数据。
2. **Wire库**：用于I2C通信，连接MPU6050和ESP32。
3. **OLEDDisplay库**：用于显示信息，支持OLED屏幕的绘制